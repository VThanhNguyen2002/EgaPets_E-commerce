#!/usr/bin/env node

/**
 * Update Railway Database Configuration
 * Script n√†y s·∫Ω c·∫≠p nh·∫≠t c·∫•u h√¨nh database v·ªõi th√¥ng tin m·ªõi nh·∫•t
 */

const fs = require('fs');
const path = require('path');

console.log('üîß Railway Database Configuration Update');
console.log('======================================\n');

// 1. C·∫≠p nh·∫≠t file sql.js v·ªõi c·∫•u h√¨nh database m·ªõi
const sqlJsPath = 'my-backend/src/shared/db/sql.js';
const newSqlConfig = `require("dotenv").config();
const { Pool } = require("pg");

// PostgreSQL connection config for Railway
const dbConfig = {
  host: process.env.DB_HOST || 'junction.proxy.rlwy.net',
  port: parseInt(process.env.DB_PORT) || 31543,
  user: process.env.DB_USER || 'postgres',
  password: process.env.DB_PASSWORD || 'sUrpZPCLOiGvsUmiBONyCmkyfygjiPTM',
  database: process.env.DB_NAME || 'railway',
  ssl: process.env.DB_SSL === 'true' ? { rejectUnauthorized: false } : { rejectUnauthorized: false },
  // Connection pool settings optimized for Railway
  max: 10, // Reduced from 20 for Railway limits
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000, // Increased timeout
  acquireTimeoutMillis: 60000, // Added acquire timeout
  createTimeoutMillis: 30000, // Added create timeout
};

console.log('üîó Database Config:', {
  host: dbConfig.host,
  port: dbConfig.port,
  database: dbConfig.database,
  ssl: !!dbConfig.ssl
});

// Create connection pool
const pool = new Pool(dbConfig);

// Handle pool errors
pool.on('error', (err) => {
  console.error('‚ùå PostgreSQL Pool Error:', err.message);
});

pool.on('connect', (client) => {
  console.log('‚úÖ New client connected to PostgreSQL');
});

pool.on('remove', (client) => {
  console.log('üîÑ Client removed from pool');
});

// Test connection and create poolPromise for backward compatibility
const poolPromise = (async () => {
  try {
    const client = await pool.connect();
    console.log("‚úÖ PostgreSQL Database Connected Successfully");
    console.log(\`üìä Connected to: \${dbConfig.host}:\${dbConfig.port}/\${dbConfig.database}\`);
    
    // Test query
    const result = await client.query('SELECT version()');
    console.log('üîç PostgreSQL Version:', result.rows[0].version.split(' ')[0]);
    
    client.release();
    return pool;
  } catch (err) {
    console.error("‚ùå PostgreSQL Database Connection Failed:", err.message);
    console.error("üîß Troubleshooting:");
    console.error("   1. Check if Railway database is running");
    console.error("   2. Verify environment variables");
    console.error("   3. Check network connectivity");
    
    // Don't exit in production, let the app handle gracefully
    if (process.env.NODE_ENV !== 'production') {
      process.exit(1);
    }
    throw err;
  }
})();

/* helper query function for PostgreSQL */
async function query(text, params = []) {
  const client = await pool.connect();
  try {
    const result = await client.query(text, params);
    return result.rows;
  } catch (error) {
    console.error('‚ùå Query Error:', error.message);
    throw error;
  } finally {
    client.release();
  }
}

function getPool() {
  return pool;
}

// For backward compatibility, create sql object with common methods
const sql = {
  Int: 'INTEGER',
  NVarChar: 'VARCHAR',
  VarBinary: 'BYTEA',
  Decimal: 'DECIMAL',
  DateTime: 'TIMESTAMP',
  Bit: 'BOOLEAN'
};

// Graceful shutdown
process.on('SIGINT', async () => {
  console.log('üîÑ Closing database connections...');
  await pool.end();
  process.exit(0);
});

process.on('SIGTERM', async () => {
  console.log('üîÑ Closing database connections...');
  await pool.end();
  process.exit(0);
});

module.exports = { sql, dbConfig, poolPromise, query, getPool, pool };
`;

fs.writeFileSync(sqlJsPath, newSqlConfig);
console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t my-backend/src/shared/db/sql.js');

// 2. C·∫≠p nh·∫≠t setup-railway-db.js v·ªõi c·∫•u h√¨nh m·ªõi
const setupScriptPath = 'my-backend/scripts/setup-railway-db.js';
const newSetupScript = `require('dotenv').config();
const { Pool } = require('pg');
const fs = require('fs');
const path = require('path');

// Railway PostgreSQL connection config - Updated
const config = {
  host: process.env.DB_HOST || 'junction.proxy.rlwy.net',
  port: parseInt(process.env.DB_PORT) || 31543,
  user: process.env.DB_USER || 'postgres',
  password: process.env.DB_PASSWORD || 'sUrpZPCLOiGvsUmiBONyCmkyfygjiPTM',
  database: process.env.DB_NAME || 'railway',
  ssl: { rejectUnauthorized: false },
  // Connection settings for Railway
  connectionTimeoutMillis: 10000,
  idleTimeoutMillis: 30000,
  max: 5 // Limit connections for setup
};

const pool = new Pool(config);

async function setupRailwayDatabase() {
  console.log('üöÄ Setting up PostgreSQL Database on Railway...');
  console.log('üìã Config:', { ...config, password: '***' });
  
  let client;
  try {
    console.log('üîÑ Attempting to connect...');
    client = await pool.connect();
    console.log('‚úÖ Connected to Railway PostgreSQL');
    
    // Check if tables already exist
    console.log('\nüîç Checking existing tables...');
    const tablesQuery = \`
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      ORDER BY table_name
    \`;
    
    const existingTables = await client.query(tablesQuery);
    console.log(\`üìä Found \${existingTables.rows.length} existing tables\`);
    
    if (existingTables.rows.length > 0) {
      console.log('üìã Existing tables:', existingTables.rows.map(r => r.table_name).join(', '));
      console.log('\n‚ö†Ô∏è Database already has tables. Skipping setup to avoid conflicts...');
      return;
    }
    
    // Only setup if no tables exist
    console.log('\nüîß Setting up fresh database...');
    
    // Read and execute the complete database SQL file
    const sqlFilePath = path.join(__dirname, '../../complete-database-with-data.sql');
    
    if (fs.existsSync(sqlFilePath)) {
      console.log('üìÑ Executing complete-database-with-data.sql...');
      
      const sqlContent = fs.readFileSync(sqlFilePath, 'utf8');
      
      // Clean SQL for Railway (remove database creation commands)
      const cleanedSql = sqlContent
        .replace(/DROP DATABASE IF EXISTS.*?;/gi, '')
        .replace(/CREATE DATABASE.*?;/gi, '')
        .replace(/\\\\c.*?;/gi, '')
        .replace(/USE.*?;/gi, '');
      
      // Execute in transaction for safety
      await client.query('BEGIN');
      
      try {
        // Split and execute statements
        const statements = cleanedSql
          .split(';')
          .map(stmt => stmt.trim())
          .filter(stmt => stmt && !stmt.startsWith('--') && stmt.length > 5);
        
        console.log(\`üìù Executing \${statements.length} SQL statements...\`);
        
        for (let i = 0; i < statements.length; i++) {
          const statement = statements[i];
          if (statement.trim()) {
            try {
              await client.query(statement);
              if (i % 10 === 0) {
                console.log(\`   Progress: \${i + 1}/\${statements.length}\`);
              }
            } catch (stmtError) {
              if (!stmtError.message.includes('already exists')) {
                console.warn(\`‚ö†Ô∏è Statement \${i + 1} warning: \${stmtError.message}\`);
              }
            }
          }
        }
        
        await client.query('COMMIT');
        console.log('‚úÖ Database setup completed successfully');
        
      } catch (error) {
        await client.query('ROLLBACK');
        throw error;
      }
      
    } else {
      console.log('‚ö†Ô∏è complete-database-with-data.sql not found, creating basic structure...');
      
      // Create basic Users table as fallback
      await client.query(\`
        CREATE TABLE IF NOT EXISTS "Users" (
          user_id SERIAL PRIMARY KEY,
          username VARCHAR(50) UNIQUE NOT NULL,
          email VARCHAR(100) UNIQUE NOT NULL,
          password_hash VARCHAR(255) NOT NULL,
          role VARCHAR(20) DEFAULT 'customer',
          created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
      \`);
      
      console.log('‚úÖ Basic table structure created');
    }
    
    // Verify setup
    console.log('\nüîç Verifying database setup...');
    const finalTablesQuery = await client.query(tablesQuery);
    console.log(\`‚úÖ Database now has \${finalTablesQuery.rows.length} tables\`);
    
    if (finalTablesQuery.rows.length > 0) {
      console.log('üìã Tables:', finalTablesQuery.rows.map(r => r.table_name).join(', '));
    }
    
  } catch (error) {
    console.error('‚ùå Railway database setup failed:', error.message);
    console.error('üîß Possible solutions:');
    console.error('   1. Check Railway database status');
    console.error('   2. Verify connection credentials');
    console.error('   3. Check network connectivity');
    console.error('   4. Try restarting Railway database');
    
    // Don't exit in production deployment
    if (process.env.NODE_ENV !== 'production') {
      process.exit(1);
    }
  } finally {
    if (client) {
      client.release();
    }
    await pool.end();
  }
}

// Run setup
if (require.main === module) {
  setupRailwayDatabase();
}

module.exports = { setupRailwayDatabase };
`;

fs.writeFileSync(setupScriptPath, newSetupScript);
console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t my-backend/scripts/setup-railway-db.js');

// 3. C·∫≠p nh·∫≠t .env.railway.example v·ªõi th√¥ng tin m·ªõi
const newEnvExample = `# Railway Environment Variables - Updated
# Copy these to your Railway project settings

# Database Configuration (Updated)
DB_HOST=junction.proxy.rlwy.net
DB_PORT=31543
DB_USER=postgres
DB_PASSWORD=sUrpZPCLOiGvsUmiBONyCmkyfygjiPTM
DB_NAME=railway
DB_SSL=true

# Server Configuration
PORT=3000
NODE_ENV=production
HOST=0.0.0.0

# Optional
FRONTEND_URL=*

# Railway Specific
RAILWAY_ENVIRONMENT=production
`;

fs.writeFileSync('.env.railway.example', newEnvExample);
console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t .env.railway.example');

// 4. C·∫≠p nh·∫≠t test connection script
const newTestScript = `const { Pool } = require('pg');

// Updated Railway PostgreSQL connection config
const config = {
  host: process.env.DB_HOST || 'junction.proxy.rlwy.net',
  port: parseInt(process.env.DB_PORT) || 31543,
  user: process.env.DB_USER || 'postgres',
  password: process.env.DB_PASSWORD || 'sUrpZPCLOiGvsUmiBONyCmkyfygjiPTM',
  database: process.env.DB_NAME || 'railway',
  ssl: { rejectUnauthorized: false },
  connectionTimeoutMillis: 10000,
  idleTimeoutMillis: 30000
};

async function testConnection() {
  console.log('üîç Testing Railway PostgreSQL connection (Updated)...');
  console.log('üìã Config:', { ...config, password: '***' });
  
  const pool = new Pool(config);
  
  try {
    console.log('üîÑ Attempting connection...');
    const client = await pool.connect();
    console.log('‚úÖ Connection successful!');
    
    const result = await client.query('SELECT version()');
    console.log('üìä PostgreSQL version:', result.rows[0].version.split(' ')[0]);
    
    const tablesResult = await client.query(\`
      SELECT table_name 
      FROM information_schema.tables 
      WHERE table_schema = 'public' 
      ORDER BY table_name
    \`);
    
    console.log(\`üìã Found \${tablesResult.rows.length} tables:\`);
    if (tablesResult.rows.length > 0) {
      tablesResult.rows.forEach(row => {
        console.log(\`   - \${row.table_name}\`);
      });
    } else {
      console.log('   (No tables found - database may need setup)');
    }
    
    client.release();
    console.log('\nüéâ Database connection test passed!');
    
  } catch (error) {
    console.error('‚ùå Connection failed:', error.message);
    console.error('\nüîß Troubleshooting steps:');
    console.error('1. Check if Railway database service is running');
    console.error('2. Verify the connection credentials are correct');
    console.error('3. Check if the database host/port has changed');
    console.error('4. Try restarting the Railway database service');
    console.error('5. Check Railway dashboard for any service issues');
  } finally {
    await pool.end();
  }
}

testConnection();
`;

fs.writeFileSync('test-railway-connection.js', newTestScript);
console.log('‚úÖ ƒê√£ c·∫≠p nh·∫≠t test-railway-connection.js');

console.log('\nüéâ C·∫≠p nh·∫≠t c·∫•u h√¨nh ho√†n th√†nh!');
console.log('\nüìã C√°c thay ƒë·ªïi ƒë√£ th·ª±c hi·ªán:');
console.log('1. ‚úÖ C·∫≠p nh·∫≠t database host: junction.proxy.rlwy.net');
console.log('2. ‚úÖ C·∫≠p nh·∫≠t database port: 31543');
console.log('3. ‚úÖ C·∫£i thi·ªán error handling v√† connection pooling');
console.log('4. ‚úÖ Th√™m graceful shutdown cho production');
console.log('5. ‚úÖ C·∫≠p nh·∫≠t t·∫•t c·∫£ scripts li√™n quan');

console.log('\nüöÄ B∆∞·ªõc ti·∫øp theo:');
console.log('1. Test k·∫øt n·ªëi: node test-railway-connection.js');
console.log('2. C·∫≠p nh·∫≠t environment variables tr√™n Railway');
console.log('3. Commit v√† push code');
console.log('4. Redeploy tr√™n Railway');